<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ZahrÃ¡dka komunita â€“ ChytrÃ© zalÃ©vÃ¡nÃ­</title>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: 2rem auto; background: #f0fdf4; padding: 1rem; color: #1a202c; }
    h1 { font-size: 1.8rem; }
    .box { background: #fff; padding: 1rem; margin-top: 1rem; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
    select, input, button { margin-top: 0.5rem; padding: 0.4rem; font-size: 1rem; }
    .recommendation { font-weight: bold; font-size: 1.2rem; margin: 1rem 0; }
    .btn { cursor: pointer; padding: 0.2rem 0.6rem; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h1>ğŸŒ¿ ZahrÃ¡dka komunita â€“ doporuÄenÃ­ & historie</h1>

  <div class="box">
    <label for="locationSelect">Vyber lokalitu:</label><br/>
    <select id="locationSelect">
      <option value="50.121,14.538">VinoÅ™ (Kbely)</option>
      <option value="50.651,13.778">DubÃ­ u Teplic</option>
      <option value="custom">VlastnÃ­ mÃ­sto</option>
    </select><br/>
    <input id="customCoords" placeholder="napÅ™. 49.8,14.3" style="display:none;" />
    <button onclick="loadAll()">ğŸ”„ NaÄÃ­st vÅ¡e</button>
  </div>

  <div class="box">
    <h2>ğŸ—“ï¸ Historie zalÃ©vÃ¡nÃ­ a srÃ¡Å¾ek (7 dnÃ­)</h2>
    <table id="combinedTable">
      <thead><tr><th>Datum</th><th>SrÃ¡Å¾ky (mm)</th><th>Zalito</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="box">
    <h2>ğŸ¤– DoporuÄenÃ­</h2>
    <div class="recommendation" id="recommendation">NaÄÃ­tÃ¡m...</div>
  </div>

  <div class="box">
    <h2>ğŸ“… DennÃ­ pÅ™edpovÄ›Ä (zÃ­tra + 2 dny)</h2>
    <table id="dailyTable"><thead><tr><th>Den</th><th>Min Â°C</th><th>Max Â°C</th><th>SrÃ¡Å¾ky mm</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="box">
    <h2>â±ï¸ HodinovÃ¡ pÅ™edpovÄ›Ä (dnes)</h2>
    <table id="hourlyTable"><thead><tr><th>ÄŒas</th><th>Teplota</th><th>SrÃ¡Å¾ky</th></tr></thead><tbody></tbody></table>
  </div>

<script>
const today = new Date();
let coords = [50.121, 14.538];

document.getElementById("locationSelect").addEventListener("change", e => {
  document.getElementById("customCoords").style.display = e.target.value === "custom" ? "inline-block" : "none";
});

function getDate(offset = 0) {
  const d = new Date();
  d.setDate(d.getDate() - offset);
  return d.toISOString().split("T")[0];
}

function loadAll() {
  const val = document.getElementById("locationSelect").value;
  if (val === "custom") {
    coords = document.getElementById("customCoords").value.split(",").map(s => parseFloat(s.trim()));
  } else {
    coords = val.split(",").map(Number);
  }
  loadCombinedHistory();
  loadForecast();
}
async function loadForecast() {
  const start = getDate(0);
  const end = getDate(3);
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${coords[0]}&longitude=${coords[1]}&hourly=temperature_2m,precipitation&daily=temperature_2m_min,temperature_2m_max,precipitation_sum&start_date=${start}&end_date=${end}&timezone=Europe%2FBerlin`;

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error("SÃ­Å¥ovÃ¡ chyba: " + res.status);
    const data = await res.json();

    console.log("Forecast data:", data);  // PÅ™idÃ¡no pro debug

    const now = new Date();

    // DennÃ­ pÅ™edpovÄ›Ä (zÃ­tra + 2 dny)
    const daily = data.daily;
    const dailyTable = document.querySelector("#dailyTable tbody");
    dailyTable.innerHTML = "";
    if (!daily || !daily.time) {
      throw new Error("DennÃ­ data chybÃ­!");
    }
    for (let i = 1; i < Math.min(4, daily.time.length); i++) {
      dailyTable.innerHTML += `<tr><td>${daily.time[i]}</td><td>${daily.temperature_2m_min[i]}</td><td>${daily.temperature_2m_max[i]}</td><td>${daily.precipitation_sum[i]}</td></tr>`;
    }

    // HodinovÃ¡ pÅ™edpovÄ›Ä (zbytek dne)
    const hourlyTable = document.querySelector("#hourlyTable tbody");
    hourlyTable.innerHTML = "";
    if (!data.hourly || !data.hourly.time) {
      throw new Error("HodinovÃ¡ data chybÃ­!");
    }
    for (let i = 0; i < data.hourly.time.length; i++) {
      const [date, time] = data.hourly.time[i].split("T");
      if (date === getDate(0) && time >= now.toISOString().split("T")[1].substring(0,5)) {
        hourlyTable.innerHTML += `<tr><td>${time}</td><td>${data.hourly.temperature_2m[i]}</td><td>${data.hourly.precipitation[i]}</td></tr>`;
      }
    }

    // DoporuÄenÃ­
    const wateredToday = localStorage.getItem("watered_" + getDate(0)) === "true";
    const wateredYesterday = localStorage.getItem("watered_" + getDate(1)) === "true";
    const rainTodayIdx = daily.time.indexOf(getDate(0));
    const rainToday = rainTodayIdx !== -1 ? daily.precipitation_sum[rainTodayIdx] : 0;

    const r = document.getElementById("recommendation");
    if (wateredToday || wateredYesterday) {
      r.textContent = "ğŸª´ Zalito nedÃ¡vno â€“ nenÃ­ potÅ™eba znovu zalÃ©vat.";
    } else if (rainToday < 1) {
      r.textContent = "ğŸ’§ Dnes asi nezaprÅ¡Ã­ â€“ doporuÄeno zalÃ­t.";
    } else {
      r.textContent = "ğŸŒ§ï¸ Dnes mÃ¡ prÅ¡et â€“ zÃ¡livka moÅ¾nÃ¡ nebude nutnÃ¡.";
    }

  } catch (err) {
    console.error("Chyba pÅ™i naÄÃ­tÃ¡nÃ­ pÅ™edpovÄ›di:", err);
    const r = document.getElementById("recommendation");
    r.textContent = "âš ï¸ Chyba pÅ™i naÄÃ­tÃ¡nÃ­ dat.";
  }
}


  }
}

window.onload = loadAll;
</script>
</body>
</html>
